# oplog-emitter [![NPM version][npm-image]][npm-url] [![Build Status][travis-image]][travis-url] [![Dependency Status][daviddm-image]][daviddm-url]
> Process your mongodb oplog as events

The module connects to a mongodb oplog and emits all of the transactions as a nodejs event emitter. This provides a much nicer high level API to work with.
All events are emitted as an `op` event. Insert, update and delete events are available as `insert`, `update` and `delete` respectively.

The module can authenticate in the admin database using username/password and allows you to pass in a custom last processed timestamp. If this is not provided, it will only emit events that occurred after the module connected to mongodb.

## Installation

```sh
$ npm install oplog-emitter
```

## Usage

```js
let OplogEmitter = require('oplog-emitter');

let emitter = new OplogEmitter('mongodb://myuser:password@localhost:27000/local?authSource=admin')
emitter.on('insert', (op) => console.log(`${op} was inserted`))
```

## TODO
* Allow more mongodb authentication mechanisms

## License

Apache-2.0 Â© [Wouter Dullaert](https://wdullaer.com)


[npm-image]: https://badge.fury.io/js/oplog-emitter.svg
[npm-url]: https://npmjs.org/package/oplog-emitter
[travis-image]: https://travis-ci.org/wdullaer/oplog-emitter.svg?branch=master
[travis-url]: https://travis-ci.org/wdullaer/oplog-emitter
[daviddm-image]: https://david-dm.org/wdullaer/oplog-emitter.svg?theme=shields.io
[daviddm-url]: https://david-dm.org/wdullaer/oplog-emitter

## API
<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### OplogOptions

An object containing the configuration options of the OplogEmitter

**Properties**

-   `oplogURL` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** A mongodb connection string to the oplog
-   `getLastTimestamp` **?[TimestampGenerator](#timestampgenerator)** A function returning a mongodb Timestamp with the starting offset in the oplog
-   `database` **?[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Filter oplog events by this database name
-   `collection` **?[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Filter oplog events by this collection name
-   `credentials` **?[Credentials](#credentials)** An object of mongodb credentials
-   `retries` **?[number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)** The amount of times to retry connecting to the database (with exponential-backoff)
-   `log` **?[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** A function which this library can use to log

### Credentials

An object with mongodb credentials of a user in the admin database

**Properties**

-   `username` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** 
-   `password` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### TimestampGenerator

A function returning a promise to a mongodb Timestamp

Returns **[Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;Timestamp>** A promise resolving to a mongodb timestamp

### OplogEmitter

**Extends EventEmitter**

An event emitter that fires for every oplog entry

**Parameters**

-   `args` **([string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String) \| [OplogOptions](#oplogoptions))** constructor options

**Examples**

```javascript
let OplogEmitter = require('oplog-emitter');
let emitter = new OplogEmitter('mongodb://localhost:27017/local?authSource=admin');

emitter.on('op', () => console.log('A transaction was added to the oplog'));
emitter.on('insert', () => console.log('An insert was done in the database'));
emitter.on('delete', () => console.log('A document was deleted in the database'));
emitter.on('update', () => console.log('A document was updated in the database'));
emitter.on('error', () => console.log('Something went wrong when reading'));
```

-   Throws **[TypeError](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypeError)** when constructor arguments are not valid
